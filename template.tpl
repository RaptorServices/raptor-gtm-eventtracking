___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Raptor Event Tracking",
  "categories": [
    "PERSONALIZATION",
    "EMAIL_MARKETING"
  ],
  "brand": {
    "id": "github.com_RaptorServices",
    "displayName": "RaptorServices",
    "thumbnail": "data:image/jpeg;base64,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"
  },
  "description": "This template can be used for implementing Raptor tracking on any website. It can be used for all types of implementations, either if it\u0027s an enhanced ecommerce setup, or a custom implementation.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SELECT",
    "name": "eventType",
    "displayName": "Event Type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "productDetail",
        "displayValue": "Product Detail (visit)"
      },
      {
        "value": "basketEvent",
        "displayValue": "Add or Remove from Basket (basket)"
      },
      {
        "value": "purchase",
        "displayValue": "Purchase (buy)"
      },
      {
        "value": "raptorModuleClick",
        "displayValue": "Raptor Module Click (itemClick)"
      },
      {
        "value": "custom",
        "displayValue": "Custom Event"
      }
    ],
    "simpleValueType": true,
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "The type of event, the tag will be tracking. If you are tracking a special type of event, use the \"Custom Event\""
  },
  {
    "type": "CHECKBOX",
    "name": "calculateSubtotal",
    "checkboxText": "Calculate subtotal",
    "simpleValueType": true,
    "alwaysInSummary": false,
    "defaultValue": true,
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ],
    "help": "Enable calculation of subtotal, being the item price x quantity. \u003cbr/\u003e For this setting to work, you need to specify the positions of the itemprice, quantity and subtotal parameters in the tracking template"
  },
  {
    "type": "SELECT",
    "name": "raptorModule",
    "displayName": "Raptor Module Clicked",
    "macrosInSelect": true,
    "selectItems": [],
    "simpleValueType": true,
    "help": "The variable in the datalayer where the name of the clicked Raptor module can be found. The variable should only have a value, when a Raptor module has been clicked. \u003cbr/\u003e \nExample: \u003cbr/\u003e\nIf a user has clicked the module \"GetSimilarItems\", the variable should contain that value.",
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "basketEvent",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "raptorModuleClick",
        "type": "EQUALS"
      }
    ],
    "notSetText": "Select Raptor Module variable"
  },
  {
    "type": "GROUP",
    "name": "subtotalParametersGroup",
    "displayName": "Custom Parameter Mapping",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "priceParameterNumber",
        "displayName": "Item Price Parameter Number (default 12)",
        "simpleValueType": true,
        "defaultValue": 12,
        "help": "Position of the item price in the tracking template. Only change this if your tracking template differs from the default",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "POSITIVE_NUMBER"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "eventType",
            "paramValue": "purchase",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "quantityParameterNumber",
        "displayName": "Quantity Parameter Number",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "eventType",
            "paramValue": "purchase",
            "type": "EQUALS"
          }
        ],
        "defaultValue": 13
      },
      {
        "type": "TEXT",
        "name": "subTotalParameterNumber",
        "displayName": "Subtotal Parameter Number (default: 5)",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "eventType",
            "paramValue": "purchase",
            "type": "EQUALS"
          }
        ],
        "defaultValue": 5
      }
    ],
    "enablingConditions": [
      {
        "paramName": "calculateSubtotal",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "eventName",
    "displayName": "Event Type Name",
    "simpleValueType": true,
    "help": "The event type (for instance \"convertion\", \"booked\", \"download\". Used only for \"custom\" eventtypes other than the known event types listed above",
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "custom",
        "type": "EQUALS"
      }
    ],
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "productDatalayerGroup",
    "displayName": "Product Datalayer",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SELECT",
        "name": "productObject",
        "displayName": "Product Detail Object",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "eventType",
            "paramValue": "purchase",
            "type": "NOT_EQUALS"
          }
        ],
        "alwaysInSummary": true,
        "notSetText": "Select product detail object from datalayer",
        "help": "Select a variable containing the product details. \u003cbr/\u003e When using enhanced ecommerce. this a variable is typically pointing to the \"ecommerce.detail.products.0\""
      },
      {
        "type": "SELECT",
        "name": "productArray",
        "displayName": "Purchased Products Array",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "help": "Select a variable containing the purchased products array.\u003cbr/\u003e\nWhen using enhanced ecommerce the variable is typically pointing to \"ecommerce.purchase.products\"",
        "notSetText": "Select product array from datalayer",
        "alwaysInSummary": true,
        "enablingConditions": [
          {
            "paramName": "eventType",
            "paramValue": "purchase",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "parameterMapping",
    "displayName": "Parameter Mapping",
    "simpleTableColumns": [
      {
        "defaultValue": "name",
        "displayName": "Parameter Type",
        "name": "parameterSource",
        "type": "SELECT",
        "selectItems": [
          {
            "value": "name",
            "displayValue": "Object Property name (for instance: \u0027Price\u0027)"
          },
          {
            "value": "variable",
            "displayValue": "Datalayer Variable or Text value"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "defaultValue": "",
        "displayName": "Parameter",
        "name": "parameterName",
        "type": "SELECT",
        "selectItems": [
          {
            "value": "p2",
            "displayValue": "p2"
          },
          {
            "value": "p3",
            "displayValue": "p3"
          },
          {
            "value": "p4",
            "displayValue": "p4"
          },
          {
            "value": "p6",
            "displayValue": "p6"
          },
          {
            "value": "p7",
            "displayValue": "p7"
          },
          {
            "value": "p8",
            "displayValue": "p8"
          },
          {
            "value": "p9",
            "displayValue": "p9"
          },
          {
            "value": "p10",
            "displayValue": "p10"
          },
          {
            "value": "p11",
            "displayValue": "p11"
          },
          {
            "value": "p12",
            "displayValue": "p12"
          },
          {
            "value": "p13",
            "displayValue": "p13"
          },
          {
            "value": "p14",
            "displayValue": "p14"
          },
          {
            "value": "p15",
            "displayValue": "p15"
          },
          {
            "value": "p16",
            "displayValue": "p16"
          },
          {
            "value": "p17",
            "displayValue": "p17"
          },
          {
            "value": "p18",
            "displayValue": "p18"
          },
          {
            "value": "p19",
            "displayValue": "p19"
          },
          {
            "value": "p20",
            "displayValue": "p20"
          },
          {
            "value": "p21",
            "displayValue": "p21"
          },
          {
            "value": "p22",
            "displayValue": "p22"
          },
          {
            "value": "p23",
            "displayValue": "p23"
          },
          {
            "value": "p24",
            "displayValue": "p24"
          },
          {
            "value": "p25",
            "displayValue": "p25"
          },
          {
            "value": "p26",
            "displayValue": "p26"
          },
          {
            "value": "p27",
            "displayValue": "p27"
          },
          {
            "value": "p28",
            "displayValue": "p28"
          },
          {
            "value": "p29",
            "displayValue": "p29"
          },
          {
            "value": "p30",
            "displayValue": "p30"
          },
          {
            "value": "p5",
            "displayValue": "p5"
          },
          {
            "value": "p31",
            "displayValue": "p31"
          },
          {
            "value": "p32",
            "displayValue": "p32"
          },
          {
            "value": "p33",
            "displayValue": "p33"
          },
          {
            "value": "p34",
            "displayValue": "p34"
          },
          {
            "value": "p35",
            "displayValue": "p35"
          },
          {
            "value": "p36",
            "displayValue": "p36"
          },
          {
            "value": "p37",
            "displayValue": "p37"
          },
          {
            "value": "p38",
            "displayValue": "p38"
          },
          {
            "value": "p39",
            "displayValue": "p39"
          },
          {
            "value": "p40",
            "displayValue": "p40"
          },
          {
            "value": "p100",
            "displayValue": "p100"
          },
          {
            "value": "p101",
            "displayValue": "p101"
          },
          {
            "value": "p102",
            "displayValue": "p102"
          },
          {
            "value": "p103",
            "displayValue": "p103"
          },
          {
            "value": "p104",
            "displayValue": "p104"
          },
          {
            "value": "p105",
            "displayValue": "p105"
          },
          {
            "value": "p106",
            "displayValue": "p106"
          },
          {
            "value": "p107",
            "displayValue": "p107"
          },
          {
            "value": "p108",
            "displayValue": "p108"
          },
          {
            "value": "p109",
            "displayValue": "p109"
          },
          {
            "value": "p110",
            "displayValue": "p110"
          },
          {
            "value": "p111",
            "displayValue": "p111"
          },
          {
            "value": "p112",
            "displayValue": "p112"
          },
          {
            "value": "p113",
            "displayValue": "p113"
          },
          {
            "value": "p114",
            "displayValue": "p114"
          },
          {
            "value": "p115",
            "displayValue": "p115"
          },
          {
            "value": "p116",
            "displayValue": "p116"
          },
          {
            "value": "p117",
            "displayValue": "p117"
          },
          {
            "value": "p118",
            "displayValue": "p118"
          },
          {
            "value": "p119",
            "displayValue": "p119"
          },
          {
            "value": "p120",
            "displayValue": "p120"
          }
        ],
        "isUnique": true
      },
      {
        "defaultValue": "",
        "displayName": "Parameter property name/value",
        "name": "parameterValue",
        "type": "TEXT",
        "macrosInSelect": true,
        "valueHint": "Product property name or variable",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "isUnique": false
      }
    ],
    "alwaysInSummary": true,
    "newRowButtonText": "Add Parameter",
    "help": "Map values to the Raptor tracking parameters by selecting values from the datalayer, or point to properties on the product object.\u003cbr/\u003e\nExample:\u003cbr/\u003e\nIf you are tracking the product detail event:\n\u003col\u003e\n\u003cli\u003eSelect the product detail object in the setting above\u003c/li\u003e\n\u003cli\u003eGo to \"implementing tracking\", in the Raptor controlpanel, and find the order of parameters in the tracking event\u003c/li\u003e\n\u003cli\u003eClick \"Add Parameter\"\u003c/li\u003e\n\u003cli\u003eIf for instance product id is positioned at parameter 2, select \"p2\" in the dropdown\u003c/li\u003e\n\u003cli\u003eIf the property of the product id is named \"id\" in the datalayer, write \"id\" in the \"parameter property name\u003c/li\u003e\n\u003cli\u003eIn \"parameter source\", Select Datalayer property name\u003c/li\u003e\n\u003c/ol\u003e\n\nNB: Parameter 1 is automatically filled out with the event type (visit, buy, basket, etc), and should not be mapped"
  },
  {
    "type": "GROUP",
    "name": "defaultSettingsGroup",
    "displayName": "Default Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "eventTypeParameter",
        "displayName": "Eventtype Parameter Number (default 1)",
        "simpleValueType": true,
        "defaultValue": 1,
        "help": "Position of the event type in the tracking template. Only change this if your tracking template differs from the default",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "POSITIVE_NUMBER"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const setInWindow = require('setInWindow');
const copyFromWindow = require('copyFromWindow');
const callInWindow = require('callInWindow');
const makeNumber = require('makeNumber');
const makeString = require('makeString');
const log = require('logToConsole');


ensureRaptor();

switch (data.eventType) {
  case 'productDetail':
    productDetailEvent();
    break;

  case 'basketEvent':
    basketEvent();
    break;

  case 'raptorModuleClick':
    productClickEvent();
    break;

  case 'purchase':
    purchaseEvent();
    break;

  default:
    defaultEvent();

}

data.gtmOnSuccess();


function productDetailEvent() {

  var product = data.productObject;

  if((data.parameterMapping == null || data.parameterMapping.length == 0) && product == null) return fail("You have no mappings.");
  if (hasNameMappings(data.parameterMapping) && product == null) return fail("No product found, but you have object property mappings.");

  var trackingObject = {};

  setMappedParameters(data, trackingObject, product);
  setEventType('visit', data.eventTypeParameter, trackingObject);
  callInWindow('raptor.push', 'trackEvent', trackingObject);

}


function defaultEvent() {

  var product = data.productObject;

  var trackingObject = {};

  setMappedParameters(data, trackingObject, product);
  setEventType(data.eventName, data.eventTypeParameter, trackingObject);
  callInWindow('raptor.push', 'trackEvent', trackingObject);

}



function basketEvent() {

  if (data.raptorModule) {


    var product = data.productObject;
    if (product) {
      var trackingObject = {};

      setMappedParameters(data, trackingObject, product);
      setEventType('itemclick', data.eventTypeParameter, trackingObject);
      callInWindow('raptor.push', 'trackEvent', trackingObject, { moduleName: data.raptorModule });
    }
  }

  var basketTracking = {};
  setMappedParameters(data, basketTracking);
  setEventType('basket', data.eventTypeParameter, basketTracking);

  callInWindow('raptor.push', 'trackEvent', basketTracking);

}

function productClickEvent() {


  var product = data.productObject;

  var tracking = {};
  setMappedParameters(data, tracking, product);
  setEventType('itemclick', data.eventTypeParameter, tracking);

  callInWindow('raptor.push', 'trackEvent', tracking, { moduleName: data.raptorModule });
}


function purchaseEvent() {

  var products = data.productArray;

  if (!products) return fail("No products array could be found");


  products.forEach(function (product) {

    var buyTracking = {};

    setMappedParameters(data, buyTracking, product);

    setEventType('buy', data.eventTypeParameter, buyTracking);

    if (data.calculateSubtotal) calculateSubtotal(product, data, buyTracking);

    callInWindow('raptor.push', 'trackEvent', buyTracking);

  });

}

function ensureRaptor() {
  var q = copyFromWindow('raptor.q');
  if (!q) q = copyFromWindow('raptor.eventQueue');

  if (!q) {

    var raptor = {
      q: [],
      push: function (event, params, options) {
        callInWindow('raptor.q.push', { event: event, params: params, options: options });
      }
    };
    setInWindow('raptor', raptor, true);
    callInWindow('raptor.push', 'trackevent', { p1: "pageview" });
  }

}


function setEventType(eventType, eventTypeParameter, trackingObject) {
  trackingObject["p" + eventTypeParameter] = eventType;
}

function calculateSubtotal(product, data, tracking) {
  var price = 0;
  var quantity = 1;

  var priceParameter = tryGetParameterFromMapping(data.priceParameterNumber);
  if (priceParameter) {
    var isName = priceParameter.parameterSource == "name";

    if (isName && product) price = product[priceParameter.parameterValue];
  }

  if (!price) price = 0;

  if (typeof (price) == 'string') {
    var priceString = price.replace(',', '.');
    price = makeNumber(priceString);
  }

  var quantityParameter = tryGetParameterFromMapping(data.quantityParameterNumber);

  if (quantityParameter) {
    var isQName = quantityParameter.parameterSource == "name";
    if (isQName && product) quantity = product[quantityParameter.parameterValue];
  }

  if (!quantity) quantity = 1;
  quantity = makeNumber(quantity);

  var subTotal = quantity * price;

  if (data.priceParameterNumber) tracking['p' + data.priceParameterNumber] = makeString(price);
  if (data.quantityParameterNumber) tracking['p' + data.quantityParameterNumber] = makeString(quantity);
  if (data.subTotalParameterNumber) tracking['p' + data.subTotalParameterNumber] = makeString(subTotal);
}

function setMappedParameters(data, trackingObject, product) {

  for (var i = 1; i <= 120; i++) {
    var foundParameter = tryGetParameterFromMapping(i);

    if (foundParameter) {
      var isVariable = foundParameter.parameterSource == "variable";
      var dataParameter = foundParameter.parameterValue;

      if (isVariable) trackingObject["p" + i] = dataParameter;

      else {
        if (product) {
          var value = product[dataParameter];
          trackingObject["p" + i] = value;
        }
      }
    }


  }
}


function tryGetParameterFromMapping(parameterNumber) {


  var params = data.parameterMapping;

  if (!params) return null;

  var foundParam = null;
  for (var i = 0; i < params.length; i++) {

    var item = params[i];

    if (item.parameterName == 'p' + parameterNumber) {
      foundParam = item;
      break;
    }

  }

  return foundParam;

}

function hasNameMappings(mappings) {
  if (mappings == null || mappings.length == 0) {
    return false;
  }

  for (var i = 0; i < mappings.length; i++) {
    var item = mappings[i];

    if (item.parameterSource == "name") {
      return true;
    }
  }

  return false;
}


function fail(msg) {
  log(msg);
  return data.gtmOnFailure();
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "raptor"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "raptor.push"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "raptor.q.push"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "raptor.q"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "raptor.eventQueue"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Should fail when no product is send in data on productDetail
  code: |-
    const mockData = {
      customerId :'1234',
      categoryPath: 'myCategoryPath',
      eventType:'productDetail',
      eventTypeParameter: 1
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnFailure').wasCalled();
- name: Should initialize Raptor queue when not present
  code: |-
    const mockData = {
      customerId :'1234',
      categoryPath: 'myCategoryPath',
      eventType:'productDetail',
      eventTypeParameter: 1,
    };

    // Call runCode to run the template's code.
    runCode(mockData);


    assertApi('callInWindow').wasCalled();
    var raptorQueue = copyFromWindow('raptor.q');
    assertThat(raptorQueue).isDefined();
    assertThat(raptorQueue.length).isEqualTo(1);
    var pageView = raptorQueue[0].params;
    assertThat(pageView).isDefined();
- name: Should set eventtype parameter correctly
  code: |
    const mockData = {
      customerId :'1234',
      categoryPath: 'myCategoryPath',
      eventType:'productDetail',
      eventTypeParameter: 16,
      productObject:{}
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    assertApi('callInWindow').wasCalled();

    var raptorQueue = copyFromWindow('raptor.q');


    assertThat(raptorQueue).isDefined();
    assertThat(raptorQueue.length).isEqualTo(2);


    var pageView = raptorQueue[0].params;
    var productDetail = raptorQueue[1].params;
    assertThat(pageView).isDefined();
    assertThat(productDetail.p16).isEqualTo('visit');


    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Should track parameter values from parameters in map
  code: "const mockData = {\n  customerId :'1234',\n  categoryPath: 'myCategoryPath',\n\
    \  eventType:'productDetail',\n  eventTypeParameter: 1,\n    parameterMapping:\
    \ [\n    {\"parameterName\":\"p2\",\"parameterValue\":\"1234\", \"parameterSource\"\
    :\"variable\"},\n    {\"parameterName\":\"p3\",\"parameterValue\":\"Iphone\",\"\
    parameterSource\":\"variable\"},\n    {\"parameterName\":\"p4\",\"parameterValue\"\
    :\"Apple/Phones\",\"parameterSource\":\"variable\"},\n    {\"parameterName\":\"\
    p40\",\"parameterValue\":\"Parameter40\",\"parameterSource\":\"variable\"}\n \
    \ ],\n  productObject:{}\n    \n};\n\n\n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\nassertApi('callInWindow').wasCalled();\nvar raptorQueue\
    \ = copyFromWindow('raptor.q');\nassertThat(raptorQueue).isDefined();\nassertThat(raptorQueue.length).isEqualTo(2);\n\
    \nvar trackingObj = raptorQueue[1].params;\nlog(trackingObj);\n\nassertThat(trackingObj.p1).isEqualTo('visit');\n\
    assertThat(trackingObj.p2).isEqualTo('1234');\nassertThat(trackingObj.p3).isEqualTo('Iphone');\n\
    assertThat(trackingObj.p4).isEqualTo('Apple/Phones');\nassertThat(trackingObj.p40).isEqualTo('Parameter40');\n\
    \n// Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();\n"
- name: Should track parameter values from mapped property names on product
  code: "const mockData = {\n  customerId :'1234',\n  categoryPath: 'myCategoryPath',\n\
    \  eventType:'productDetail',\n  eventTypeParameter: 1,\n    parameterMapping:\
    \ [\n    {\"parameterName\":\"p2\",\"parameterValue\":\"id\", \"parameterKind\"\
    :\"name\"},\n    {\"parameterName\":\"p3\",\"parameterValue\":\"name\",\"parameterKind\"\
    :\"name\"},\n    {\"parameterName\":\"p4\",\"parameterValue\":\"category\",\"\
    parameterKind\":\"name\"}\n  ],\n  productObject:{\n          'name': 'Apple Macbook\
    \ Pro',         \n          'id': '12345',\n          'price': '12995',\n    \
    \      'brand': 'Apple',\n          'category': 'Apple/Laptops',\n          'variant':\
    \ 'Gray',\n          'quantity': 1\n        }\n   \n};\n\n\n// Call runCode to\
    \ run the template's code.\nrunCode(mockData);\n\n\nassertApi('callInWindow').wasCalled();\n\
    \nvar raptorQueue = copyFromWindow('raptor.q');\n\n\nassertThat(raptorQueue).isDefined();\n\
    assertThat(raptorQueue.length).isEqualTo(2);\n\n\nvar pageView = raptorQueue[0].params;\n\
    var productDetail = raptorQueue[1].params;\nassertThat(pageView).isDefined();\n\
    assertThat(productDetail.p1).isEqualTo('visit');\nassertThat(productDetail.p2).isEqualTo('12345');\n\
    assertThat(productDetail.p3).isEqualTo('Apple Macbook Pro');\nassertThat(productDetail.p4).isEqualTo('Apple/Laptops');\n\
    \n\n\n// Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();\n"
- name: Should track basket content on add
  code: |-
    const mockData = {
      customerId :'1234',
      eventType:'basketEvent',
      eventTypeParameter: 1,
       parameterMapping: [
        {"parameterName":"p10","parameterValue":"12345,23456", "parameterSource":"variable"},//basket content
        {"parameterName":"p11","parameterValue":"3333","parameterSource":"variable"},//basket Id
       ],
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    var raptorQueue = copyFromWindow('raptor.q');

    assertThat(raptorQueue).isDefined();
    assertThat(raptorQueue.length).isEqualTo(2);

    var basketEvent = raptorQueue[1].params;

    assertThat(basketEvent.p1).isEqualTo('basket');
    assertThat(basketEvent.p10).isEqualTo('12345,23456');
    assertThat(basketEvent.p11).isEqualTo('3333');

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Should track itemclick on raptor basket event
  code: |-
    const mockData = {
      customerId :'1234',
      eventType:'basketEvent',
      raptorModule: 'GetSimilarItems',
      eventTypeParameter: 1,
      productObject: {
        id:'12345'
      },
       parameterMapping: [
        {"parameterName":"p2","parameterValue":"id", "parameterKind":"name"}
       ],
    };

    // Call runCode to run the template's code.
    runCode(mockData);


    assertApi('callInWindow').wasCalled();

    var raptorQueue = copyFromWindow('raptor.q');


    assertThat(raptorQueue).isDefined();
    assertThat(raptorQueue.length).isEqualTo(3);

    var pageView = raptorQueue[0].params;
    var itemClick = raptorQueue[1].params;
    var basketEvent = raptorQueue[1].params;

    assertThat(pageView).isDefined();


    assertThat(itemClick.p1).isEqualTo('itemclick');
    assertThat(itemClick.p2).isEqualTo('12345');



    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Should track purchase events
  code: "const mockData = {\n  customerId :'1234',\n  eventType:'purchase',\n  eventTypeParameter:\
    \ 1,\n  priceParameterNumber: 12,\n  quantityParameterNumber: 13,\n  subTotalParameterNumber:\
    \ 16,\n  calculateSubtotal: true,\n  productArray: [\n    {\n      id:'12345',\n\
    \      name:'Apple Macbook Pro',\n      price:'12995',\n      quantity:1\n   \
    \ },\n    {\n      id:'2345',\n      name:'Apple Iphone',\n      price:1000,\n\
    \      quantity:2\n    }\n  ],\n   parameterMapping: [\n    {\"parameterName\"\
    :\"p2\",\"parameterValue\":\"id\", \"parameterSource\":\"name\"},\n    {\"parameterName\"\
    :\"p3\",\"parameterValue\":\"name\", \"parameterSource\":\"name\"},\n     {\"\
    parameterName\":\"p12\",\"parameterValue\":\"price\", \"parameterSource\":\"name\"\
    },\n     {\"parameterName\":\"p13\",\"parameterValue\":\"quantity\", \"parameterSource\"\
    :\"name\"},\n     {\"parameterName\":\"p6\",\"parameterValue\":\"DKK\", \"parameterSource\"\
    :\"variable\"},\n     \n   ],\n};\n\n\n// Call runCode to run the template's code.\n\
    runCode(mockData);\n\nassertApi('callInWindow').wasCalled();\nvar raptorQueue\
    \ = copyFromWindow('raptor.q');\nassertThat(raptorQueue).isNotNull();\nassertThat(raptorQueue.length).isEqualTo(3);\n\
    \nvar event1 = raptorQueue[1].params;\n\nassertThat(event1).isDefined();\nassertThat(event1.p1).isEqualTo('buy');\n\
    assertThat(event1.p2).isEqualTo('12345');\nassertThat(event1.p3).isEqualTo('Apple\
    \ Macbook Pro');\nassertThat(event1.p16).isEqualTo('12995');\nassertThat(event1.p6).isEqualTo('DKK');\n\
    assertThat(event1.p12).isEqualTo('12995');\nassertThat(event1.p13).isEqualTo('1');\n\
    \n\nvar event2 = raptorQueue[2].params;\nassertThat(event2).isDefined();\nassertThat(event2.p1).isEqualTo('buy');\n\
    assertThat(event2.p2).isEqualTo('2345');\nassertThat(event2.p3).isEqualTo('Apple\
    \ Iphone');\nassertThat(event2.p16).isEqualTo('2000');\nassertThat(event2.p6).isEqualTo('DKK');\n\
    assertThat(event2.p12).isEqualTo('1000');\nassertThat(event2.p13).isEqualTo('2');\n\
    \n// Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();"
- name: Should track product click events
  code: |-
    const mockData = {
      customerId :'1234',
      eventType:'raptorModuleClick',
      eventTypeParameter: 1,
       parameterMapping: [
        {"parameterName":"p2","parameterValue":"12345", "parameterSource":"variable"},
        {"parameterName":"p3","parameterValue":"Apple Macbook Pro","parameterSource":"variable"},
        ],
    };

    runCode(mockData);

    assertApi('callInWindow').wasCalled();
    var raptorQueue = copyFromWindow('raptor.q');
    assertThat(raptorQueue).isNotNull();
    assertThat(raptorQueue.length).isEqualTo(2);

    var clickEvent = raptorQueue[1].params;

    assertThat(clickEvent).isDefined();
    assertThat(clickEvent.p1).isEqualTo('itemclick');
    assertThat(clickEvent.p2).isEqualTo('12345');
    assertThat(clickEvent.p3).isEqualTo('Apple Macbook Pro');



    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Should track custom event
  code: |-
    const mockData = {
      customerId :'1234',
      eventType:'custom',
      eventTypeParameter: 1,
      eventName: 'myCustomEvent',
      parameterMapping: [
        {"parameterName":"p2","parameterValue":"myValue", "parameterSource":"variable"},
      ],
    };



    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();

    assertApi('callInWindow').wasCalled();
    var raptorQueue = copyFromWindow('raptor.q');
    assertThat(raptorQueue).isNotNull();
    assertThat(raptorQueue.length).isEqualTo(2);

    var event1 = raptorQueue[1].params;

    assertThat(event1).isDefined();
    assertThat(event1.p1).isEqualTo('myCustomEvent');
    assertThat(event1.p2).isEqualTo('myValue');
- name: Should track purchase events with custom object names
  code: "const mockData = {\n  customerId :'1234',\n  eventType:'purchase',\n  eventTypeParameter:\
    \ 1,\n  priceParameterNumber: 12,\n  quantityParameterNumber: 13,\n  subTotalParameterNumber:\
    \ 16,\n  calculateSubtotal: true,\n  productArray: [\n    {\n      id:'12345',\n\
    \      productName:'Pantalon',\n      productUnitPrice: '29.99',\n      productDiscount:'29.99',\n\
    \      quantity:1\n    },\n    {\n      id:'2345',\n      productName:'Tunique',\n\
    \      productUnitPrice: 29.99,\n      productDiscount: 19.99,\n      quantity:2\n\
    \    }\n  ],\n   parameterMapping: [\n    {\"parameterName\":\"p2\",\"parameterValue\"\
    :\"id\", \"parameterSource\":\"name\"},\n    {\"parameterName\":\"p3\",\"parameterValue\"\
    :\"productName\", \"parameterSource\":\"name\"},\n     {\"parameterName\":\"p12\"\
    ,\"parameterValue\":\"productDiscount\", \"parameterSource\":\"name\"},\n    \
    \ {\"parameterName\":\"p13\",\"parameterValue\":\"quantity\", \"parameterSource\"\
    :\"name\"},\n     {\"parameterName\":\"p6\",\"parameterValue\":\"DKK\", \"parameterSource\"\
    :\"variable\"},\n     \n   ],\n};\n\n\n// Call runCode to run the template's code.\n\
    runCode(mockData);\n\nassertApi('callInWindow').wasCalled();\nvar raptorQueue\
    \ = copyFromWindow('raptor.q');\nassertThat(raptorQueue).isNotNull();\nassertThat(raptorQueue.length).isEqualTo(3);\n\
    \nvar event1 = raptorQueue[1].params;\n\nassertThat(event1).isDefined();\nassertThat(event1.p1).isEqualTo('buy');\n\
    assertThat(event1.p2).isEqualTo('12345');\nassertThat(event1.p3).isEqualTo('Pantalon');\n\
    assertThat(event1.p16).isEqualTo('29.99');\nassertThat(event1.p6).isEqualTo('DKK');\n\
    assertThat(event1.p12).isEqualTo('29.99');\nassertThat(event1.p13).isEqualTo('1');\n\
    \n\nvar event2 = raptorQueue[2].params;\nassertThat(event2).isDefined();\nassertThat(event2.p1).isEqualTo('buy');\n\
    assertThat(event2.p2).isEqualTo('2345');\nassertThat(event2.p3).isEqualTo('Tunique');\n\
    assertThat(event2.p16).isEqualTo('39.98');\nassertThat(event2.p6).isEqualTo('DKK');\n\
    assertThat(event2.p12).isEqualTo('19.99');\nassertThat(event2.p13).isEqualTo('2');\n\
    \n// Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();"
- name: Should track productDetails if no product but DataLayer and Text mappings
  code: |-
    const mockData = {
      customerId :'1234',
      categoryPath: 'myCategoryPath',
      eventType:'productDetail',
      eventTypeParameter: 1,
      parameterMapping: [
         {"parameterName":"p3","parameterValue":"myProduct", "parameterSource":"variable"},
      ]
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();

    var raptorQueue = copyFromWindow('raptor.q');

    var event1 = raptorQueue[1].params;

    assertThat(event1).isDefined();
    assertThat(event1.p1).isEqualTo('visit');
    assertThat(event1.p3).isEqualTo('myProduct');
- name: Should track productDetails if product and has both types of mappings
  code: |-
    const mockData = {
      customerId :'1234',
      categoryPath: 'myCategoryPath',
      eventType:'productDetail',
      eventTypeParameter: 1,
      productObject:{productName: "Test"},
      parameterMapping: [
         {"parameterName":"p3","parameterValue":"myProduct", "parameterSource":"variable"},
         {"parameterName":"p4","parameterValue":"productName", "parameterSource":"name"},
      ]
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();

    var raptorQueue = copyFromWindow('raptor.q');

    var event1 = raptorQueue[1].params;

    assertThat(event1).isDefined();
    assertThat(event1.p1).isEqualTo('visit');
    assertThat(event1.p3).isEqualTo('myProduct');
    assertThat(event1.p4).isEqualTo('Test');
- name: Should fail productDetails if no product and has name mappings
  code: |-
    const mockData = {
      customerId :'1234',
      categoryPath: 'myCategoryPath',
      eventType:'productDetail',
      eventTypeParameter: 1,
      parameterMapping: [
         {"parameterName":"p3","parameterValue":"myProduct", "parameterSource":"name"},
      ]
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnFailure').wasCalled();
- name: Should track productDetails if product and only DataLayer and Text mappings
  code: |-
    const mockData = {
      customerId :'1234',
      categoryPath: 'myCategoryPath',
      eventType:'productDetail',
      eventTypeParameter: 1,
      productObject:{productName: "Test"},
      parameterMapping: [
         {"parameterName":"p3","parameterValue":"myProduct", "parameterSource":"variable"},
      ]
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();

    var raptorQueue = copyFromWindow('raptor.q');

    var event1 = raptorQueue[1].params;

    assertThat(event1).isDefined();
    assertThat(event1.p1).isEqualTo('visit');
    assertThat(event1.p3).isEqualTo('myProduct');
- name: Should track basketEvent if basketContent is empty
  code: |-
    const mockData = {
      customerId :'1234',
      eventType:'basketEvent',
      eventTypeParameter: 1,
       parameterMapping: [
        {"parameterName":"p10","parameterValue":"", "parameterSource":"variable"},//basket content
        {"parameterName":"p11","parameterValue":"3925737","parameterSource":"variable"},//basket Id
        {"parameterName":"p2","parameterValue":"000000001946072","parameterSource":"variable"},//removed item id
       ],
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    var raptorQueue = copyFromWindow('raptor.q');

    assertThat(raptorQueue).isDefined();
    assertThat(raptorQueue.length).isEqualTo(2);

    var basketEvent = raptorQueue[1].params;

    assertThat(basketEvent.p1).isEqualTo('basket');
    assertThat(basketEvent.p10).isEqualTo('');
    assertThat(basketEvent.p11).isEqualTo('3925737');
    assertThat(basketEvent.p2).isEqualTo('000000001946072');

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Should track parameters above 100
  code: |-
    const mockData = {
      customerId :'1234',
      eventType:'custom',
      eventTypeParameter: 1,
      eventName: 'myCustomEvent',
      parameterMapping: [
        {"parameterName":"p101","parameterValue":"myValue", "parameterSource":"variable"},
      ],
    };



    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();

    assertApi('callInWindow').wasCalled();
    var raptorQueue = copyFromWindow('raptor.q');
    assertThat(raptorQueue).isNotNull();
    assertThat(raptorQueue.length).isEqualTo(2);

    var event1 = raptorQueue[1].params;

    assertThat(event1).isDefined();
    assertThat(event1.p1).isEqualTo('myCustomEvent');
    assertThat(event1.p101).isEqualTo('myValue');
setup: |-
  const copyFromWindow = require('copyFromWindow');
  const log = require('logToConsole');
  const setInWindow = require('setInWindow');

  setInWindow('raptor',null,true);


___NOTES___

Created on 5.11.2020 09.54.06


